## Betting System

The betting system allows users to place bets directly on numbers for Shillong Teer rounds.

### Key Files

- client/src/components/play/NumberGrid.tsx: Grid for selecting numbers
- client/src/components/play/BettingForm.tsx: Form for submitting bets
- client/src/pages/play-page.tsx: Page combining NumberGrid and BettingForm
- server/routes.ts: API endpoints for placing bets
- server/storage.ts: Storage methods for bets

### Betting Flow

1. Number Selection:
   - User selects numbers (00-99) from the NumberGrid
   - Selected numbers are highlighted in orange

2. Bet Configuration:
   - User enters bet amount for selected numbers
   - User selects round (1 or 2)

3. Bet Submission:
   - User reviews and submits the bet
   - Client validates bet and sends to server
   - Server validates bet (time, user balance, etc.)
   - Bet is stored and user balance is updated

4. Bet Status:
   - Bets are initially in "pending" status
   - When results are posted, bets are updated to "won" or "lost"
   - Winning bets result in balance updates and notifications

### NumberGrid Component (client/src/components/play/NumberGrid.tsx)

```tsx
interface NumberGridProps {
  onNumberSelect: (num: number) => void;
  selectedNumbers: number[];
}

export default function NumberGrid({ onNumberSelect, selectedNumbers }: NumberGridProps) {
  // Generate numbers from 0 to 99
  const numbers = Array.from({ length: 100 }, (_, i) => i);

  return (
    <div className="grid grid-cols-5 sm:grid-cols-10 gap-2 w-full">
      {numbers.map((num) => {
        const isSelected = selectedNumbers.includes(num);
        return (
          <button
            key={num}
            onClick={() => onNumberSelect(num)}
            className={`
              h-12 w-full text-white font-bold rounded-md
              transition-colors duration-200
              ${isSelected ? 'bg-orange-500 hover:bg-orange-400' : 'bg-gray-800 hover:bg-gray-700'}
            `}
            aria-label={`Select number ${num}`}
            aria-pressed={isSelected}
          >
            {num.toString().padStart(2, '0')}
          </button>
        );
      })}
    </div>
  );
}
```

### BettingForm Component (client/src/components/play/BettingForm.tsx)

```tsx
interface BettingFormProps {
  selectedNumbers: number[];
  selectedRound: number;
  onResetSelection: () => void;
}

export default function BettingForm({ selectedNumbers, selectedRound, onResetSelection }: BettingFormProps) {
  const { user } = useAuth();
  const [betAmount, setBetAmount] = useState<number>(10);
  const { toast } = useToast();
  const { addNotification } = useNotification();
  
  // Calculate total bet amount
  const totalAmount = selectedNumbers.length * betAmount;
  
  // Define bet mutation
  const placeBetMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch('/api/bets', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: user?.id,
          numbers: selectedNumbers.map(n => n.toString().padStart(2, '0')),
          amount: betAmount,
          round: selectedRound,
          date: new Date(),
          status: 'pending',
        }),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Failed to place bet');
      }
      
      return await response.json();
    },
    onSuccess: () => {
      toast({
        title: 'Bet placed successfully',
        description: `You placed a bet of â‚¹${totalAmount} on ${selectedNumbers.length} numbers for Round ${selectedRound}`,
      });
      addNotification('Bet placed successfully!', 'info', true);
      onResetSelection();
      queryClient.invalidateQueries({ queryKey: ['/api/user'] });
    },
    onError: (error: Error) => {
      toast({
        variant: 'destructive',
        title: 'Failed to place bet',
        description: error.message,
      });
    },
  });
  
  // Handle form submission
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validate bet
    if (selectedNumbers.length === 0) {
      toast({
        variant: 'destructive',
        title: 'No numbers selected',
        description: 'Please select at least one number to place a bet',
      });
      return;
    }
    
    if (betAmount <= 0) {
      toast({
        variant: 'destructive',
        title: 'Invalid bet amount',
        description: 'Please enter a positive bet amount',
      });
      return;
    }
    
    if (!user || totalAmount > (user.balance as number)) {
      toast({
        variant: 'destructive',
        title: 'Insufficient balance',
        description: 'You do not have enough balance to place this bet',
      });
      return;
    }
    
    // Check if the round is closed
    if (isRoundClosed(selectedRound === 1 ? 15 : 16, 30)) {
      toast({
        variant: 'destructive',
        title: 'Round closed',
        description: `Round ${selectedRound} is closed for betting. Please try again tomorrow.`,
      });
      return;
    }
    
    // Place bet
    placeBetMutation.mutate();
  };
  
  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Form content */}
    </form>
  );
}
```

### Play Page Integration (client/src/pages/play-page.tsx)

```tsx
export default function PlayPage() {
  const [selectedNumbers, setSelectedNumbers] = useState<number[]>([]);
  const [selectedRound, setSelectedRound] = useState<number>(1);

  // Handle number selection
  const handleNumberSelect = (num: number) => {
    if (selectedNumbers.includes(num)) {
      setSelectedNumbers(selectedNumbers.filter((n) => n !== num));
    } else {
      setSelectedNumbers([...selectedNumbers, num]);
    }
  };

  // Reset selection
  const handleResetSelection = () => {
    setSelectedNumbers([]);
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-6 text-white">Place Your Bet</h1>
      
      {/* Round selection */}
      <div className="mb-6">
        <h2 className="text-xl font-semibold mb-3 text-white">Select Round</h2>
        <div className="flex space-x-4">
          <Button
            variant={selectedRound === 1 ? "default" : "outline"}
            onClick={() => setSelectedRound(1)}
          >
            Round 1 (3:30 PM)
          </Button>
          <Button
            variant={selectedRound === 2 ? "default" : "outline"}
            onClick={() => setSelectedRound(2)}
          >
            Round 2 (4:30 PM)
          </Button>
        </div>
      </div>
      
      {/* Number grid */}
      <div className="mb-6">
        <h2 className="text-xl font-semibold mb-3 text-white">Select Numbers</h2>
        <NumberGrid
          onNumberSelect={handleNumberSelect}
          selectedNumbers={selectedNumbers}
        />
      </div>
      
      {/* Betting form */}
      <BettingForm
        selectedNumbers={selectedNumbers}
        selectedRound={selectedRound}
        onResetSelection={handleResetSelection}
      />
    </div>
  );
}
```

### Server-Side API (server/routes.ts)

```typescript
// Place a bet
app.post('/api/bets', async (req, res) => {
  try {
    // Ensure user is authenticated
    if (!req.isAuthenticated()) {
      return res.status(401).json({ message: 'You must be logged in to place a bet' });
    }
    
    const userId = (req.user as any).id;
    
    // Validate request body
    const betData = insertBetSchema.parse({
      ...req.body,
      userId, // Override with authenticated user ID
    });
    
    // Check if the round is closed
    const roundHour = betData.round === 1 ? 15 : 16;
    if (isRoundClosed(roundHour, 30)) {
      return res.status(400).json({ message: `Round ${betData.round} is closed for betting` });
    }
    
    // Get user
    const user = await storage.getUser(userId);
    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }
    
    // Calculate total bet amount
    const totalAmount = betData.numbers.length * Number(betData.amount);
    
    // Check if user has enough balance
    if (Number(user.balance) < totalAmount) {
      return res.status(400).json({ message: 'Insufficient balance' });
    }
    
    // Place bet
    const bet = await storage.placeBet(betData);
    
    // Update user balance
    await storage.updateUserBalance(userId, -totalAmount);
    
    // Create transaction
    await storage.createTransaction({
      userId,
      amount: -totalAmount,
      type: 'bet',
      reference: `bet:${bet.id}`,
      status: 'completed',
    });
    
    res.status(201).json(bet);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ message: 'Validation failed', errors: error.errors });
    }
    console.error('Error placing bet:', error);
    res.status(500).json({ message: 'Failed to place bet' });
  }
});
```

### Validation

- Time Validation: Bets cannot be placed after round closing time
- Balance Validation: Users cannot bet more than their available balance
- Number Validation: Numbers must be in the valid range (00-99)
- Amount Validation: Bet amounts must meet minimum and maximum requirements

```typescript
// Check if round is closed (from client/src/lib/utils.ts)
export function isRoundClosed(targetHour: number, targetMinute: number): boolean {
  const now = new Date();
  const targetTime = new Date();
  
  // Set target time
  targetTime.setHours(targetHour, targetMinute, 0, 0);
  
  // Check if current time is after target time
  return now > targetTime;
}
```

### Winning Logic

When results are posted, the system automatically processes bets to determine winners:

```typescript
// Process winning bets (simplified example)
async function processWinningBets(resultId: number) {
  try {
    // Get result
    const result = await storage.getResult(resultId);
    if (!result) {
      throw new Error('Result not found');
    }
    
    // Get pending bets for the day
    const date = new Date(result.date);
    date.setHours(0, 0, 0, 0);
    const endDate = new Date(date);
    endDate.setHours(23, 59, 59, 999);
    
    const bets = await storage.getBetsByDateRange(date, endDate);
    
    // Process each bet
    for (const bet of bets) {
      if (bet.status !== 'pending') {
        continue;
      }
      
      // Get result for the corresponding round
      const resultNumber = bet.round === 1 ? result.round1 : result.round2;
      if (resultNumber === null || resultNumber === undefined) {
        continue;
      }
      
      // Check if bet numbers include the result number
      const hasWon = bet.numbers.includes(resultNumber.toString().padStart(2, '0'));
      
      if (hasWon) {
        // Calculate winnings (80x the bet amount)
        const winAmount = Number(bet.amount) * 80;
        
        // Update bet
        await storage.updateBet(bet.id, {
          status: 'won',
          winAmount,
        });
        
        // Update user balance
        await storage.updateUserBalance(bet.userId, winAmount);
        
        // Create transaction
        await storage.createTransaction({
          userId: bet.userId,
          amount: winAmount,
          type: 'win',
          reference: `bet:${bet.id}`,
          status: 'completed',
        });
      } else {
        // Update bet as lost
        await storage.updateBet(bet.id, {
          status: 'lost',
          winAmount: 0,
        });
      }
    }
  } catch (error) {
    console.error('Error processing winning bets:', error);
    throw error;
  }
}
```
